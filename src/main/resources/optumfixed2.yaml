---
a:
  operation: loadpage
b:
  operation: token
  url: https://www.optumrx.com/bin/oauth/token
c:
  operation: extendablefetcher
  authheader: true
  extendedheaders:
    - Accept: Application/json
    - actor: RXP
    - bypass_saml: "true"
    - impersonating: "false"
    - iris_resilient: "true"
    - Referer: https://www.optumrx.com/oe_rxexternal/prescription-drug-list?type=ClientFormulary&var=PHSCA&infoid=PHSCA
    - scope: Read
    - Sec-Fetch-Dest: empty
    - Sec-Fetch-Mode: cors
    - Sec-Fetch-Site: same-origin
  javascriptOperator: |
    var callback = arguments[arguments.length - 1];
    fetch('https://www.optumrx.com/public-services/formularydrugs?ctime=1625497138985&drugName=A&formularyId=PHSCA&userType=other&viewMode=NAME',
    { mode: 'no-cors',headers: { 'Accept': 'application/json'}})
    .then(response => response.json())
    .then(data => {callback(data.Drugs);});
  variable: druglist
d:
  operation: filter
  fromvariable: druglist
  tovariable: filtereddruglist
  type: filtermap
  evaluation: |
    def newlist = [];
    capturelists.get('druglist').each { g ->
        if(g.containsKey('BrandName') && g.get('BrandName').toString().contains('ABILIFY')){
            newlist.add(g)
        }
    };
    return newlist;
e:
  operation: loop
  type: variable
  variable: filtereddruglist
  subscript: druglookup
f:
  operation: capturelisttosnapshots
  variable: drugResults

subscripts:
  druglookup:
    a:
      operation: extendablefetcher
      authheader: true
      extendedheaders:
        - Accept: Application/json
        - actor: RXP
        - bypass_saml: "true"
        - impersonating: "false"
        - iris_resilient: "true"
        - Referer: https://www.optumrx.com/oe_rxexternal/prescription-drug-list?type=ClientFormulary&var=PHSCA&infoid=PHSCA
        - scope: Read
        - Sec-Fetch-Dest: empty
        - Sec-Fetch-Mode: cors
        - Sec-Fetch-Site: same-origin
      javascriptOperator: |
        var callback = arguments[arguments.length - 1]; fetch('https://www.optumrx.com/public-services/formularydrugs?formularyId=PHSCA&userType=other&viewMode=id&drugId={variable}&ctime=1625499684610',
        { mode: 'no-cors',headers: {'Accept': 'application/json'}})
        .then(response => response.json())
        .then(data => {callback(data.Drugs);});
      variable: drugResults
      variableMapValue: Id